#! /usr/bin/env python

import os, re, sys
import Options
from TaskGen import feature, after
from waf_dynamo import dmsdk_add_files, remove_flag

def set_options(opt):
    pass


@feature('config_neon')
@after('configure')
def config_neon(conf):
    conf.env.append_unique('CCFLAGS', '-mfpu=neon')

def configure(conf):
    if 'web' in conf.env.PLATFORM:
        conf.env.append_unique('CCDEFINES', 'WEBP_FORCE_ALIGNED')
        conf.env.append_unique('CXXDEFINES', 'WEBP_FORCE_ALIGNED')

def build(bld):
    if not Options.options.skip_build_tests:
        bld.add_subdirs('test')

    source_dirs = 'dlib dlib/jsmn zlib lz4'.split(' ')
    mbedtls_dirs = 'mbedtls/crypto/library mbedtls/library'.split(' ')

    if re.match('arm.*?android', bld.env.PLATFORM):
        source_dirs.append('dlib/linux')
        source_dirs.append('dlib/android')
    elif 'darwin' in bld.env.PLATFORM or 'ios' in bld.env.PLATFORM:
        source_dirs.append('dlib/darwin')
    elif 'win32' in bld.env.PLATFORM:
        source_dirs.append('dlib/win32')
    elif ('linux'  in bld.env.PLATFORM) or ('android' in bld.env.PLATFORM):
        source_dirs.append('dlib/linux')
    elif 'web' in bld.env.PLATFORM:
        source_dirs.append('dlib/js')

    extra_defines = ['ZLIB_CONST']

    if 'win32' not in bld.env.PLATFORM:
        extra_defines.append('Z_HAVE_UNISTD_H')
        extra_defines.append('HAVE_HIDDEN')
        extra_defines.append('CONFIG_USE_DEV_URANDOM')
    else:
        pass
        # NOTE: CONFIG_WIN32_USE_CRYPTO_LIB is disabled
        # on windows due to compile error in RNG_custom_init()
        # when CONFIG_WIN32_USE_CRYPTO_LIB is set (missing entropy_pool, see top of file)

    local_objs = []
    webp_source_dirs = 'webp webp/dsp webp/utils webp/dec'.split(' ')
    webp_source_no_neon = []
    if re.match('arm.*?android', bld.env.PLATFORM):
        # On Android arm, we create a separate neon lib with the selected floating-point hardware NEON extension.
        # This means that floating-point operations are not generated by GCC's auto-vectorization pass unless -funsafe-math-optimizations is also specified.
        # This is because NEON hardware does not fully implement the IEEE 754 standard for floating-point arithmetic
        #  (in particular denormal values are treated as zero), so the use of NEON instructions may lead to a loss of precision.
        # In other words - we only want this setting for dedicated neon code.
        webp_source_neon = ['webp/dsp/dec_neon.c', 'webp/dsp/lossless_neon.c', 'webp/dsp/rescaler_neon.c', 'webp/dsp/upsampling_neon.c']
        android_features = 'cc'
        if 'armv7-android' in bld.env.PLATFORM:
            android_features += ' config_neon' # neon is implicit on arm64 android
        neonobjs = bld.new_task_gen(features = android_features,
                                includes = 'webp',
                                #source = webp_source_neon,
                                target = 'webp_neon_objs' )
        local_objs.append('webp_neon_objs')
        neonobjs.find_sources_in_dirs(webp_source_dirs)
        webp_source_no_neon = [x for x in neonobjs.source if x not in webp_source_neon]
        neonobjs.source = webp_source_neon
    else:
        source_dirs.extend(webp_source_dirs)

    dlib = bld.new_task_gen(features = 'cc cxx cstaticlib',
                            includes = '. ./mbedtls/include ./mbedtls/crypto/include',
                            add_objects = local_objs,
                            target = 'dlib',
                            defines= ['VALGRIND'] + extra_defines)
    dlib.find_sources_in_dirs(source_dirs)
    dlib.source.extend(webp_source_no_neon)

    # Create a separate library, in order to separate it from the ASAN builds
    dlib_noasan = bld.new_task_gen(features = 'cc cxx cstaticlib skip_asan',
                            includes = '. ./mbedtls/include ./mbedtls/crypto/include',
                            add_objects = local_objs,
                            target = 'dlib_noasan',
                            defines= ['VALGRIND'] + extra_defines)
    dlib_noasan.find_sources_in_dirs(source_dirs)
    dlib_noasan.source.extend(webp_source_no_neon)

    # If we have optimizations on, let's minimize this library
    opt_level = getattr(Options.options, 'opt_level', '')
    FLAG_ST = '/O%s' if 'win' == bld.env.BUILD_PLATFORM else '-O%s'
    remove_flags = {}
    if opt_level in ['3','2']:
        remove_flags['CCFLAGS'] = []
        remove_flags['CCFLAGS'].append( (FLAG_ST % opt_level, 0) )
        # if in release mode we'll only keep a (non verbose) print function
        extra_defines += ['MBEDTLS_ERROR_STRERROR_DUMMY']
    else:
        extra_defines += ['MBEDTLS_ERROR_C']

    mbedtls = bld.new_task_gen(features = 'cc cstaticlib remove_flags',
                            includes = '. ./mbedtls/include ./mbedtls/crypto/include',
                            target = 'mbedtls',
                            remove_flags = remove_flags,
                            defines= ['VALGRIND'] + extra_defines)
    mbedtls.find_sources_in_dirs(mbedtls_dirs)
    mbedtls.env.append_unique('CCFLAGS', FLAG_ST % 's')

    # Create a separate library, in order to separate it from the ASAN builds
    mbedtls_noasan = bld.new_task_gen(features = 'cc cstaticlib skip_asan',
                            includes = '. ./mbedtls/include ./mbedtls/crypto/include',
                            target = 'mbedtls_noasan',
                            defines= ['VALGRIND'] + extra_defines)
    mbedtls_noasan.find_sources_in_dirs(mbedtls_dirs)

    dlib.source.remove(os.path.join('dlib', 'socket_null.cpp'))
    dlib_noasan.source.remove(os.path.join('dlib', 'socket_null.cpp'))

    if 'web' in bld.env['PLATFORM']:
        dlib.source.remove(os.path.join('dlib', 'dns.cpp'))
        dlib_noasan.source.remove(os.path.join('dlib', 'dns.cpp'))
    else:
        dlib.source.remove(os.path.join('dlib', 'dns_null.cpp'))
        dlib_noasan.source.remove(os.path.join('dlib', 'dns_null.cpp'))

    desktop = bld.env['PLATFORM'] in ('x86_64-darwin', 'x86_64-linux', 'x86_64-win32')
    if desktop:
        uselib = ['UUID', 'PLATFORM_SOCKET', 'CARES']

        dlib = bld.new_task_gen(features = 'cc cxx cshlib skip_asan',
                                includes = '. ./mbedtls/include ./mbedtls/crypto/include',
                                add_objects = local_objs,
                                uselib_local = 'mbedtls_noasan',
                                target = 'dlib_shared',
                                defines= ['VALGRIND'] + extra_defines,
                                uselib = uselib)

        dlib.find_sources_in_dirs(source_dirs)
        dlib.source.extend(webp_source_no_neon)

        dlib.source.remove(os.path.join('dlib', 'socket_null.cpp'))

        if 'web' in bld.env['PLATFORM']:
            dlib.source.remove(os.path.join('dlib', 'dns.cpp'))
        else:
            dlib.source.remove(os.path.join('dlib', 'dns_null.cpp'))

        if 'win32' not in bld.env['PLATFORM']:
            dlib = bld.new_task_gen(features = 'cc cxx cshlib',
                                    source='dlib/memprofile.cpp',
                                    includes = '.',
                                    target = 'dlib_memprofile',
                                    defines= 'DM_LIBMEMPROFILE')

            if 'linux' in bld.env['PLATFORM']:
                dlib.env.append_value('LINKFLAGS', [ '-ldl' ])

    classpath = ['%s/ext/share/java/junit-4.6.jar' % bld.env.DYNAMO_HOME]
    classpath = os.pathsep.join(classpath)

    bld.new_task_gen(features='javac seq',
                     classpath=classpath,
                     source_root='java')

    bld.env["JAVACFLAGS"] = '-g -source 1.7 -target 1.7'.split()

    bld.new_task_gen(features='jar seq',
                     basedir='java',
                     destfile='dlib.jar')

    bld.install_files('${PREFIX}/share/java', 'dlib.jar')

    bld.new_task_gen(features='javac seq',
                     classpath=classpath  + os.pathsep + 'default/src/java',
                     source_root='java_test')

    # the dmsdk_add_files needs to be after a build group for some reason
    dmsdk_add_files(bld, '${PREFIX}/sdk/include/dmsdk', 'dmsdk')

    bld.install_files('${PREFIX}/include/dlib', 'dlib/align.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/buffer.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/array.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/atomic.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/configfile.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/condition_variable.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/dns.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/easing.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/endian.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/dstrings.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/dlib.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/crypt.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/message.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/hashtable.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/hash.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/http_cache.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/http_cache_verify.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/http_client.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/http_server.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/index_pool.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/object_pool.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/image.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/log.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/math.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/memory.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/platform.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/poolallocator.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/profile.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/pprint.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/memprofile.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/path.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/safe_windows.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/shared_library.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/socket.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/spinlock.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/ssdp.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/ssdp_private.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/static_assert.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/stringpool.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/sys.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/template.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/transform.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/trig_lookup.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/mutex.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/thread.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/time.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/utf8.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/uri.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/vmath.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/web_server.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/zlib.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/lz4.h')
    bld.install_files('${PREFIX}/include/dlib', 'dlib/webp.h')

    bld.install_files('${PREFIX}/lib/python/dlib', 'python/dlib/__init__.py')
    bld.install_files('${PREFIX}/lib/python', 'dlib/memprofile.py')
    bld.install_files('${PREFIX}/bin', '../bin/memprofile.sh', chmod=0755)

    if 'web' in bld.env['PLATFORM']:
        bld.install_files('${PREFIX}/lib/%s/js' % bld.env['PLATFORM'], 'dlib/js/library_sys.js')
